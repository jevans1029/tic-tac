<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tic Tac Toe</title>
  <link rel="stylesheet" href="./css/tic-tac-toe.css" />
  <style>
    #tictactoe.locked {
      pointer-events: none;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <main class="container">

    <!-- ðŸ” Login/Register Section -->
    <div id="auth-section">
      <form id="login-form" style="margin-bottom: 20px;">
        <input type="text" name="username" placeholder="Username" required />
        <input type="password" name="password" placeholder="Password" required />
        <button type="submit">Login</button>
        <button type="button" onclick="window.location.href='/register.html'">Register</button>
      </form>
    </div>

    <!-- ðŸ‘‹ Welcome Section -->
    <div id="welcome-section" style="display: none; margin-bottom: 20px;">
      <h3 id="welcome-msg"></h3>
    </div>

    <!-- ðŸŒ— Theme Toggle -->
    <div class="theme-toggle">
      <input type="checkbox" id="theme-switch" />
      <label for="theme-switch">Toggle Dark/Light Mode</label>
    </div>

    <!-- ðŸŽ® Game Board -->
    <div id="tictactoe" class="locked" role="grid"></div>

    <div id="player" align="center">
      <span id="turn" role="status" aria-live="polite">Player X</span>
    </div>

    <!-- ðŸŽ® Games List -->
    <div id="games-section" style="display: none; margin-top: 20px;">
      <h3>Your Games</h3>
      <button onclick="fetchGames()">Refresh Games</button>
      <div id="games-list"></div>
    </div>
  </main>

  <!-- ðŸ§  Game Logic -->
  <script type="module" src="./js/tic-tac-toe.js"></script>

  <!-- ðŸ” Login Script -->
<script type="module">
  // Attach event listeners after DOM loads
  const themeSwitch = document.getElementById('theme-switch');
  if (themeSwitch) {
    themeSwitch.addEventListener('change', function () {
      document.body.classList.toggle('dark', this.checked);
    });
  }

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = e.target.username.value;
    const password = e.target.password.value;

    try {
      const res = await fetch('http://localhost:8000/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();

      if (!res.ok || data.error) {
        alert('Login failed: ' + (data.error || 'Invalid credentials'));
        return;
      }

      // Success
      alert('Login successful!');
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('welcome-section').style.display = 'block';
      document.getElementById('games-section').style.display = 'block';
      document.getElementById('welcome-msg').innerText = `Welcome, ${username}!`;
      document.getElementById('tictactoe').classList.remove('locked');
      fetchGames(); // Load initial games list

      // ðŸŸ¢ Reattach toggle in case DOM changes
      const toggle = document.getElementById('theme-switch');
      if (toggle && !toggle.hasListener) {
        toggle.addEventListener('change', function () {
          document.body.classList.toggle('dark', this.checked);
        });
        toggle.hasListener = true;
      }

    } catch (err) {
      console.error(err);
      alert('Login error: ' + err.message);
    }
  });

  // Add games fetching function
  window.fetchGames = async function() {
    try {
      const res = await fetch('http://localhost:8000/games', {
        credentials: 'include'
      });
      const games = await res.json();
      
      const gamesList = document.getElementById('games-list');
      gamesList.innerHTML = games.map(game => `
        <div style="border: 1px solid #ccc; margin: 10px; padding: 10px;">
          <p>Game #${game.id}</p>
          <p>Winner: ${game.winner || 'Draw'}</p>
          <p>Played: ${new Date(game.played_at).toLocaleString()}</p>
        </div>
      `).join('');
    } catch (err) {
      console.error('Failed to fetch games:', err);
    }
  };
</script>




</body>
</html>
